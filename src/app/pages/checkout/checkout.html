<div class="checkout-container">
  <div class="checkout-header">
    <button mat-icon-button (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>Checkout</h1>
  </div>

  <div class="checkout-content">
    
    <!-- Order Summary Section -->
    <div class="order-items-summary">
      <mat-card>
        <mat-card-header>
          <mat-card-title>
            <mat-icon>shopping_cart</mat-icon>
            Your Order ({{ cartItems().length }} items)
          </mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <div class="items-list">
            @for (item of cartItems(); track item.book.id) {
              <div class="cart-item">
                <img [src]="item.book.thumbnailUrl" [alt]="item.book.title" class="item-image">
                <div class="item-info">
                  <h4>{{ item.book.title }}</h4>
                  <p class="item-author">{{ item.book.author }}</p>
                  <p class="item-quantity">Quantity: {{ item.quantity }}</p>
                </div>
                <div class="item-price">
                  <p class="unit-price">${{ item.book.price }}</p>
                  <p class="total-price">${{ item.book.price * item.quantity }}</p>
                </div>
              </div>
              <mat-divider></mat-divider>
            }
          </div>
          
          <div class="summary-total">
            <div class="total-row">
              <span>Subtotal:</span>
              <span> ${{ totalPrice() }}</span>
            </div>
            <div class="total-row">
              <span>Shipping:</span>
              <span>Free</span>
            </div>
            <mat-divider></mat-divider>
            <div class="total-row grand-total">
              <strong>Total:</strong>
              <strong>{{ totalPrice() | currency:'VND' }}</strong>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <mat-stepper linear #stepper>
      <!-- Step 1: Customer Information -->
      <mat-step [stepControl]="customerInfoForm">
        <form [formGroup]="customerInfoForm">
          <ng-template matStepLabel>Customer Information</ng-template>
          
          <mat-card>
            <mat-card-content>
              <mat-form-field appearance="outline">
                <mat-label>Full Name</mat-label>
                <input matInput formControlName="fullName" placeholder="Nguyen Van A">
                <mat-icon matPrefix>person</mat-icon>
                <mat-error>{{ getErrorMessage(customerInfoForm, 'fullName') }}</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Email</mat-label>
                <input matInput formControlName="email" placeholder="example@email.com">
                <mat-icon matPrefix>email</mat-icon>
                <mat-error>{{ getErrorMessage(customerInfoForm, 'email') }}</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Phone Number</mat-label>
                <input matInput formControlName="phone" placeholder="0123456789">
                <mat-icon matPrefix>phone</mat-icon>
                <mat-error>{{ getErrorMessage(customerInfoForm, 'phone') }}</mat-error>
              </mat-form-field>
            </mat-card-content>

            <mat-card-actions>
              <button mat-raised-button color="primary" matStepperNext>
                Next
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </form>
      </mat-step>

      <!-- Step 2: Shipping Address -->
      <mat-step [stepControl]="shippingAddressForm">
        <form [formGroup]="shippingAddressForm">
          <ng-template matStepLabel>Shipping Address</ng-template>
          
          <mat-card>
            <mat-card-content>
              <mat-form-field appearance="outline">
                <mat-label>Street Address</mat-label>
                <input matInput formControlName="street" placeholder="123 Main Street">
                <mat-icon matPrefix>home</mat-icon>
                <mat-error>{{ getErrorMessage(shippingAddressForm, 'street') }}</mat-error>
              </mat-form-field>

              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Ward</mat-label>
                  <input matInput formControlName="ward">
                  <mat-error>{{ getErrorMessage(shippingAddressForm, 'ward') }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>District</mat-label>
                  <input matInput formControlName="district">
                  <mat-error>{{ getErrorMessage(shippingAddressForm, 'district') }}</mat-error>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>City</mat-label>
                  <input matInput formControlName="city">
                  <mat-error>{{ getErrorMessage(shippingAddressForm, 'city') }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Zip Code</mat-label>
                  <input matInput formControlName="zipCode" placeholder="70000">
                  <mat-error>{{ getErrorMessage(shippingAddressForm, 'zipCode') }}</mat-error>
                </mat-form-field>
              </div>
            </mat-card-content>

            <mat-card-actions>
              <button mat-button matStepperPrevious>Back</button>
              <button mat-raised-button color="primary" matStepperNext>
                Next
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </form>
      </mat-step>

      <!-- Step 3: Payment & Review -->
      <mat-step [stepControl]="paymentForm">
        <form [formGroup]="paymentForm">
          <ng-template matStepLabel>Payment & Review</ng-template>
          
          <mat-card>
            <mat-card-content>
              <h3>Payment Method</h3>
              <mat-radio-group formControlName="paymentMethod">
                <mat-radio-button value="cod">
                  <mat-icon>local_shipping</mat-icon>
                  Cash on Delivery (COD)
                </mat-radio-button>
                <mat-radio-button value="bank">
                  <mat-icon>account_balance</mat-icon>
                  Bank Transfer
                </mat-radio-button>
                <mat-radio-button value="credit">
                  <mat-icon>credit_card</mat-icon>
                  Credit Card
                </mat-radio-button>
              </mat-radio-group>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Order Note (Optional)</mat-label>
                <textarea matInput formControlName="note" rows="3" 
                          placeholder="Any special instructions?"></textarea>
              </mat-form-field>
            </mat-card-content>

            <mat-card-actions>
              <button mat-button matStepperPrevious>Back</button>
              <button mat-raised-button color="primary" 
                      (click)="onSubmit()" 
                      [disabled]="isSubmitting()">
                @if (isSubmitting()) {
                  <mat-icon>hourglass_empty</mat-icon>
                  Processing...
                } @else {
                  <mat-icon>check_circle</mat-icon>
                  Place Order
                }
              </button>
            </mat-card-actions>
          </mat-card>
        </form>
      </mat-step>
    </mat-stepper>
  </div>
</div>